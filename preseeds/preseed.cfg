d-i preseed/early_command string /bin/sh -c 'echo PRESEED WORKS > /tmp/preseed-works'

### Localization - English with US locale
d-i debian-installer/locale string en_US.UTF-8
d-i localechooser/supported-locales multiselect en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select es

### Network Configuration
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string dlesieur42
d-i netcfg/get_domain string

### Firmware — never prompt, just load if available
d-i hw-detect/load_firmware boolean true

### Mirror Settings
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

### Account Setup - Using simple passwords during install
d-i passwd/root-password password temproot123
d-i passwd/root-password-again password temproot123
d-i passwd/user-fullname string dlesieur
d-i passwd/username string dlesieur
d-i passwd/user-password password tempuser123
d-i passwd/user-password-again password tempuser123
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Clock and Time Zone
d-i clock-setup/utc boolean true
d-i time/zone string Europe/Madrid

### Partitioning - FULLY AUTOMATED with Encrypted LVM
# Critical: Set automatic partitioning method
d-i partman-auto/init_automatically_partition select Guided - use entire disk and set up encrypted LVM
d-i partman-auto/method string crypto
d-i partman-crypto/passphrase password tempencrypt123
d-i partman-crypto/passphrase-again password tempencrypt123

# Skip the random data wipe — pointless in a VM (VDI is already zeroed)
# This saves 10-30+ minutes on a 32GB disk
# Both keys for compatibility: old (partman-crypto) + new trixie (partman-auto-crypto)
d-i partman-auto-crypto/erase_disks boolean false
d-i partman-crypto/erase_data boolean false

# Select the disk to partition
d-i partman-auto/disk string /dev/sda

# Force the automatic partitioning
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string LVMGroup
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# Critical: Force automatic creation of partitions
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_write_new_label boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman-crypto/confirm boolean true
d-i partman-crypto/confirm_nooverwrite boolean true

# Set the recipe for custom partitioning
# Disk: 32GB (~30720MB usable). Boot: 500MB. Crypto/LVM: rest (~30200MB).
# LV total: 4500+1024+2500+2000+1500+1500+2000 = 15024MB (fits easily).
d-i partman-auto/expert_recipe string \
    boot-root :: \
        500 500 500 ext4 \
            $primary{ } $bootable{ } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /boot } \
        . \
        15000 15000 -1 crypto \
            $primary{ } \
            method{ crypto } \
            $lvmignore{ } \
        . \
        4500 4500 4500 ext4 \
            $lvmok{ } \
            lv_name{ root } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ / } \
        . \
        1024 1024 1024 linux-swap \
            $lvmok{ } \
            lv_name{ swap } \
            method{ swap } format{ } \
        . \
        2500 2500 2500 ext4 \
            $lvmok{ } \
            lv_name{ home } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /home } \
        . \
        2000 2000 2000 ext4 \
            $lvmok{ } \
            lv_name{ var } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /var } \
        . \
        1500 1500 1500 ext4 \
            $lvmok{ } \
            lv_name{ srv } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /srv } \
        . \
        1500 1500 1500 ext4 \
            $lvmok{ } \
            lv_name{ tmp } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /tmp } \
        . \
        2000 2000 2000 ext4 \
            $lvmok{ } \
            lv_name{ var-log } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /var/log } \
        .

# Force finish and write partitions
d-i partman/early_command string \
    debconf-set partman-auto/disk "$(list-devices disk | head -n1)"

### Base system installation
d-i base-installer/install-recommends boolean false
d-i base-installer/kernel/image string linux-image-amd64

### APT setup — mirror + non-free firmware (required for Debian 13)
d-i apt-setup/cdrom/set-first boolean false
d-i apt-setup/cdrom/set-next boolean false
d-i apt-setup/cdrom/set-failed boolean false
d-i apt-setup/disable-cdrom-entries boolean true
d-i apt-setup/non-free-firmware boolean true
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/use_mirror boolean true
d-i apt-setup/services-select multiselect security, updates
d-i apt-setup/security_host string security.debian.org

### Software Selection
tasksel tasksel/first multiselect standard
d-i pkgsel/include string openssh-server
d-i pkgsel/upgrade select none
popularity-contest popularity-contest/participate boolean false
d-i pkgsel/install-language-support boolean false

# Force non-interactive mode
d-i debconf/priority select critical
d-i auto-install/enable boolean true
# Prevent any leftover prompts from bubbling up
d-i preseed/run string

### Bootloader (GRUB) Installation
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string /dev/sda
# Skip the "GRUB install to MBR?" prompt
d-i grub-installer/grub2_instead_of_grub_legacy boolean true
d-i grub-installer/choose_bootdev select /dev/sda

### Finish Installation
# The installer will halt+poweroff after completion.
# The orchestrator detects VM poweroff from VBoxManage, switches boot
# order from DVD→disk, removes the ISO, and starts the VM from disk.
d-i cdrom-detect/eject boolean true
d-i finish-install/reboot_in_progress note
d-i finish-install/keep-consoles boolean true
d-i debian-installer/exit/halt boolean true
d-i debian-installer/exit/poweroff boolean true

### Post-installation commands - FULL Born2beRoot Configuration + WordPress
# STRATEGY: All scripts are stored as separate files on the ISO (/cdrom/).
# late_command copies them to /target, then runs the main setup via in-target.
# This avoids ALL escaping issues, env-var problems, and busybox quirks.
# Only ONE in-target call, with || true so it can never hang the installer.
# The final 'poweroff -f' ensures VirtualBox sees a real ACPI shutdown
# (busybox 'halt' doesn't always trigger ACPI, leaving VM stuck at
# "System halted").
d-i preseed/late_command string \
    cp /cdrom/b2b-setup.sh /target/tmp/b2b-setup.sh; \
    cp /cdrom/monitoring.sh /target/usr/local/bin/monitoring.sh; \
    cp /cdrom/first-boot-setup.sh /target/root/first-boot-setup.sh; \
    in-target /bin/bash /tmp/b2b-setup.sh || true; \
    echo '#!/bin/sh' > /target/lib/systemd/system-shutdown/vbox-poweroff.sh; \
    echo 'sleep 1 && /sbin/poweroff -f' >> /target/lib/systemd/system-shutdown/vbox-poweroff.sh; \
    chmod +x /target/lib/systemd/system-shutdown/vbox-poweroff.sh || true
