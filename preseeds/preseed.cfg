# Current Date and Time (UTC - YYYY-MM-DD HH:MM:SS formatted): 2025-04-01 16:45:23
# Current User's Login: LESdylan

d-i preseed/early_command string /bin/sh -c 'echo PRESEED WORKS > /tmp/preseed-works'

### Localization - English with US locale
d-i debian-installer/locale string en_US.UTF-8
d-i localechooser/supported-locales multiselect en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select es

### Network Configuration
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string dlesieur
d-i netcfg/get_domain string

### Mirror Settings (Spain)
d-i mirror/country string ES
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

### Account Setup - Using simple passwords during install
d-i passwd/root-password password temproot123
d-i passwd/root-password-again password temproot123
d-i passwd/user-fullname string dlesieur
d-i passwd/username string dlesieur
d-i passwd/user-password password tempuser123
d-i passwd/user-password-again password tempuser123
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

### Clock and Time Zone
d-i clock-setup/utc boolean true
d-i time/zone string Europe/Madrid

### Partitioning - FULLY AUTOMATED with Encrypted LVM
# Critical: Set automatic partitioning method
d-i partman-auto/init_automatically_partition select Guided - use entire disk and set up encrypted LVM
d-i partman-auto/method string crypto
d-i partman-crypto/passphrase password tempencrypt123
d-i partman-crypto/passphrase-again password tempencrypt123

# Select the disk to partition
d-i partman-auto/disk string /dev/sda

# Force the automatic partitioning
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string LVMGroup
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# Critical: Force automatic creation of partitions
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_write_new_label boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman-crypto/confirm boolean true
d-i partman-crypto/confirm_nooverwrite boolean true

# Set the recipe for custom partitioning
d-i partman-auto/expert_recipe string \
    boot-root :: \
        500 500 500 ext4 \
            $primary{ } $bootable{ } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /boot } \
        . \
        30300 30300 30300 crypto \
            $primary{ } \
            method{ crypto } \
            $lvmignore{ } \
        . \
        10000 10000 10000 ext4 \
            $lvmok{ } \
            lv_name{ root } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ / } \
        . \
        2300 2300 2300 linux-swap \
            $lvmok{ } \
            lv_name{ swap } \
            method{ swap } format{ } \
        . \
        5000 5000 5000 ext4 \
            $lvmok{ } \
            lv_name{ home } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /home } \
        . \
        3000 3000 3000 ext4 \
            $lvmok{ } \
            lv_name{ var } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /var } \
        . \
        3000 3000 3000 ext4 \
            $lvmok{ } \
            lv_name{ srv } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /srv } \
        . \
        3000 3000 3000 ext4 \
            $lvmok{ } \
            lv_name{ tmp } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /tmp } \
        . \
        4000 4000 4000 ext4 \
            $lvmok{ } \
            lv_name{ var-log } \
            method{ format } format{ } \
            use_filesystem{ } filesystem{ ext4 } \
            mountpoint{ /var/log } \
        .

# Force finish and write partitions
d-i partman/early_command string \
    debconf-set partman-auto/disk "$(list-devices disk | head -n1)"

### Software Selection
tasksel tasksel/first multiselect standard
d-i pkgsel/include string openssh-server
d-i pkgsel/upgrade select none
popularity-contest popularity-contest/participate boolean false
d-i pkgsel/install-language-support boolean false

# Disable all automatic apt setup - we'll configure manually
d-i apt-setup/use_mirror boolean false
d-i apt-setup/services-select multiselect 
d-i apt-setup/security_host string
d-i base-installer/install-recommends boolean false

# Force non-interactive mode
d-i debconf/priority select critical
d-i auto-install/enable boolean true

### Bootloader (GRUB) Installation
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string /dev/sda

### Finish Installation
d-i finish-install/reboot_in_progress note

### Post-installation commands - FULL Born2beRoot Configuration + WordPress
d-i preseed/late_command string \
    in-target sh -c "echo 'deb http://deb.debian.org/debian trixie main contrib non-free non-free-firmware' > /etc/apt/sources.list"; \
    in-target sh -c "echo 'deb http://deb.debian.org/debian trixie-updates main contrib non-free non-free-firmware' >> /etc/apt/sources.list"; \
    DEBIAN_FRONTEND=noninteractive in-target apt-get clean; \
    DEBIAN_FRONTEND=noninteractive in-target apt-get update || true; \
    DEBIAN_FRONTEND=noninteractive in-target apt-get -o Dpkg::Use-Pty=0 -o Acquire::Retries=3 -o Acquire::http::Timeout=60 install -y --allow-unauthenticated --fix-missing sudo ufw curl wget net-tools vim; \
    DEBIAN_FRONTEND=noninteractive in-target apt-get -o Dpkg::Use-Pty=0 -o Acquire::Retries=3 -o Acquire::http::Timeout=60 install -y --allow-unauthenticated --fix-missing libpam-pwquality apparmor apparmor-utils cron haveged; \
    DEBIAN_FRONTEND=noninteractive in-target apt-get -o Dpkg::Use-Pty=0 -o Acquire::Retries=3 -o Acquire::http::Timeout=60 install -y --allow-unauthenticated --fix-missing lighttpd mariadb-server php-fpm php-mysql php-cgi php-mbstring php-xml php-gd php-curl; \
    \
    in-target groupadd user42 || true; \
    in-target usermod -aG sudo,user42 dlesieur; \
    \
    in-target sed -i 's/^#*Port 22/Port 4242/' /etc/ssh/sshd_config; \
    in-target sed -i 's/^#*PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config; \
    in-target sed -i 's/^#*PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config; \
    in-target systemctl enable ssh; \
    \
    in-target ufw default deny incoming; \
    in-target ufw default allow outgoing; \
    in-target ufw allow 4242/tcp; \
    in-target ufw allow 80/tcp; \
    in-target ufw allow 443/tcp; \
    in-target sh -c "echo 'y' | ufw enable || true"; \
    \
    in-target mkdir -p /var/log/sudo; \
    in-target sh -c "echo 'Defaults        passwd_tries=3' > /etc/sudoers.d/sudo_config"; \
    in-target sh -c "echo 'Defaults        badpass_message=\"Wrong password. Access denied!\"' >> /etc/sudoers.d/sudo_config"; \
    in-target sh -c "echo 'Defaults        logfile=\"/var/log/sudo/sudo.log\"' >> /etc/sudoers.d/sudo_config"; \
    in-target sh -c "echo 'Defaults        log_input,log_output' >> /etc/sudoers.d/sudo_config"; \
    in-target sh -c "echo 'Defaults        iolog_dir=\"/var/log/sudo\"' >> /etc/sudoers.d/sudo_config"; \
    in-target sh -c "echo 'Defaults        requiretty' >> /etc/sudoers.d/sudo_config"; \
    in-target sh -c "echo 'Defaults        secure_path=\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin\"' >> /etc/sudoers.d/sudo_config"; \
    in-target chmod 440 /etc/sudoers.d/sudo_config; \
    \
    in-target sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS\t30/' /etc/login.defs; \
    in-target sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS\t2/' /etc/login.defs; \
    in-target sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE\t7/' /etc/login.defs; \
    in-target sed -i 's/^PASS_MIN_LEN.*/PASS_MIN_LEN\t10/' /etc/login.defs; \
    \
    in-target sh -c "sed -i 's/^# minlen = .*/minlen = 10/' /etc/security/pwquality.conf"; \
    in-target sh -c "sed -i 's/^# dcredit = .*/dcredit = -1/' /etc/security/pwquality.conf"; \
    in-target sh -c "sed -i 's/^# ucredit = .*/ucredit = -1/' /etc/security/pwquality.conf"; \
    in-target sh -c "sed -i 's/^# lcredit = .*/lcredit = -1/' /etc/security/pwquality.conf"; \
    in-target sh -c "sed -i 's/^# maxrepeat = .*/maxrepeat = 3/' /etc/security/pwquality.conf"; \
    in-target sh -c "sed -i 's/^# usercheck = .*/usercheck = 1/' /etc/security/pwquality.conf"; \
    in-target sh -c "sed -i 's/^# difok = .*/difok = 7/' /etc/security/pwquality.conf"; \
    in-target sh -c "sed -i 's/^# enforce_for_root.*/enforce_for_root/' /etc/security/pwquality.conf"; \
    \
    in-target sh -c "cat > /usr/local/bin/monitoring.sh << 'MONITORING_EOF'\n#!/bin/bash\nARCH=\$(uname -a)\nPCPU=\$(grep 'physical id' /proc/cpuinfo | sort -u | wc -l)\nVCPU=\$(grep processor /proc/cpuinfo | wc -l)\nRAM_TOTAL=\$(free -m | awk '/Mem:/ {print \$2}')\nRAM_USED=\$(free -m | awk '/Mem:/ {print \$3}')\nRAM_PERC=\$(free | awk '/Mem:/ {printf(\"%.2f\"), \$3/\$2*100}')\nDISK_TOTAL=\$(df -h --total | awk '/total/ {print \$2}')\nDISK_USED=\$(df -h --total | awk '/total/ {print \$3}')\nDISK_PERC=\$(df -k --total | awk '/total/ {print \$5}')\nCPU_LOAD=\$(top -bn1 | grep 'Cpu(s)' | sed 's/.*, *\\([0-9.]*\\)%* id.*/\\1/' | awk '{print 100 - \$1\"%\"}')\nLAST_BOOT=\$(who -b | awk '{print \$3, \$4}')\nLVM_USE=\$(lsblk | grep -q lvm && echo yes || echo no)\nTCP_CONN=\$(ss -t | grep ESTAB | wc -l)\nUSERS=\$(who | wc -l)\nIP=\$(hostname -I | awk '{print \$1}')\nMAC=\$(ip link show | awk '/ether/ {print \$2}')\nSUDO_CMDS=\$(journalctl _COMM=sudo | grep COMMAND | wc -l)\n\nwall \"\n#Architecture: \$ARCH\n#CPU physical: \$PCPU\n#vCPU: \$VCPU\n#Memory Usage: \$RAM_USED/\${RAM_TOTAL}MB (\${RAM_PERC}%)\n#Disk Usage: \$DISK_USED/\$DISK_TOTAL (\$DISK_PERC)\n#CPU load: \$CPU_LOAD\n#Last boot: \$LAST_BOOT\n#LVM use: \$LVM_USE\n#Connections TCP: \$TCP_CONN ESTABLISHED\n#User log: \$USERS\n#Network: IP \$IP (\$MAC)\n#Sudo: \$SUDO_CMDS cmd\n\"\nMONITORING_EOF"; \
    in-target chmod +x /usr/local/bin/monitoring.sh; \
    \
    in-target sh -c "echo '*/10 * * * * root /usr/local/bin/monitoring.sh' >> /etc/crontab"; \
    \
    in-target lighty-enable-mod fastcgi; \
    in-target lighty-enable-mod fastcgi-php; \
    \
    in-target systemctl enable lighttpd; \
    in-target systemctl enable mariadb; \
    in-target systemctl enable haveged; \
    in-target systemctl enable php7.4-fpm || systemctl enable php8.2-fpm; \
    \
    in-target sh -c "mysql -u root << 'MYSQL_EOF'\nCREATE DATABASE wordpress;\nCREATE USER 'wpuser'@'localhost' IDENTIFIED BY 'wppass123';\nGRANT ALL PRIVILEGES ON wordpress.* TO 'wpuser'@'localhost';\nFLUSH PRIVILEGES;\nMYSQL_EOF"; \
    \
    in-target sh -c "cd /var/www/html && wget https://wordpress.org/latest.tar.gz && tar -xzf latest.tar.gz && rm latest.tar.gz && chown -R www-data:www-data wordpress"; \
    \
    in-target sh -c "cat > /var/www/html/wordpress/wp-config.php << 'WPCONFIG_EOF'\n<?php\ndefine('DB_NAME', 'wordpress');\ndefine('DB_USER', 'wpuser');\ndefine('DB_PASSWORD', 'wppass123');\ndefine('DB_HOST', 'localhost');\ndefine('DB_CHARSET', 'utf8');\ndefine('DB_COLLATE', '');\n\$table_prefix = 'wp_';\n\ndefine('WP_DEBUG', false);\n\nif ( ! defined( 'ABSPATH' ) ) {\n\tdefine( 'ABSPATH', __DIR__ . '/' );\n}\n\nrequire_once ABSPATH . 'wp-settings.php';\nWPCONFIG_EOF"; \
    \
    in-target systemctl enable cron; \
    in-target systemctl restart ssh; \
    in-target systemctl restart lighttpd; \
    in-target systemctl restart mariadb
